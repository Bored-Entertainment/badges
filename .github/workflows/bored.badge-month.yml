name: Bored Monthly Badge 
on:
  schedule: [{cron: "0 0 1/2 * *"}]
jobs:
  create-badge:
      runs-on: ubuntu-latest
      name: Create Badge
      steps:
        - name: Checkout 🛎️
          uses: actions/checkout@v2
          with:
            persist-credentials: false

        - name: Fetch API Data 📦
          run: curl https://data.jsdelivr.com/v1/package/gh/pisaucer/boredhtml/stats/version/month > data.json
          
        - name: Read Data From Json 📚
          id: read-data
          uses: notiz-dev/github-action-json-property@release
          with: 
            path: 'data.json'
            prop_path: 'total'
      
        - name: Sigin to git
          run: |
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"

        - name: Remove old Badge
          run: |
            git rm bored/month.svg
            git commit -m "remove bored/month.svg"

        - name: Generate the badge SVG image
          uses: emibcn/badge-action@v1
          id: badge
          with:
            label: 'cdn.boredht.ml'
            status: ${{ steps.read-data.outputs.prop }} hits/month
            color: 'yellow'
            path: ./bored/month.svg

        - name: Upload badge as artifact
          uses: actions/upload-artifact@v2
          with:
            name: badge
            path: ./bored/month.svg
            if-no-files-found: error

        - name: Extract branch name
          shell: bash
          run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
          id: extract_branch
        - name: Commit badge
          env:
            BADGE: ./bored/month.svg
          run: |
            git add "${BADGE}"
            git commit -m "Bored Update Monthly Badge"
        - name: Push badge commit
          uses: ad-m/github-push-action@master
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            branch: ${{ steps.extract_branch.outputs.branch }}
